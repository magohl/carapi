####### mo testing composition for a fake car order
---
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: car-api
  labels:
    provider: http
    service: car-api
    version: v2
spec:
  compositeTypeRef:
    apiVersion: automation.magnus.lan/v1alpha1
    kind: Car
  
  mode: Pipeline
  pipeline:
  
  - step: create-car-request
    functionRef:
      name: function-patch-and-transform
    input:
      apiVersion: pt.fn.crossplane.io/v1beta1
      kind: Resources
      resources:
      - name: car-http-request
        base:
          apiVersion: http.crossplane.io/v1alpha2
          kind: Request
          spec:
            deletionPolicy: Delete
            forProvider:
              payload:
                baseUrl: http://carapi-service.carapi.svc.cluster.local:8000 #"https://carapi.soapfault.com"
                body: |
                  {
                    "make": "Toyota",
                    "model": "Camry",
                    "color": "Blue"
                  }

              # order matters!
              mappings:
              - method: "POST"
                url: .payload.baseUrl + "/api/cars"
                body: .payload.body
                headers:
                  Content-Type: 
                  - "application/json"

              - method: "GET"
                url: (.payload.baseUrl + "/api/cars/" + (.response.body.id|tostring))
                headers:
                  Accept:
                  - "application/json"

              - method: "PUT"
                url: (.payload.baseUrl + "/api/cars/" + (.response.body.id|tostring))
                body: .payload.body
                headers:
                  Content-Type: 
                  - "application/json"

              - method: "DELETE" 
                url: (.payload.baseUrl + "/api/cars/" + (.response.body.id|tostring))

        patches:
        - type: FromCompositeFieldPath
          fromFieldPath: metadata.name
          toFieldPath: metadata.name
          transforms:
          - type: string
            string:
              type: Format
              fmt: "%s-car-request"
        
        - type: FromCompositeFieldPath
          fromFieldPath: spec.apiUrl
          toFieldPath: spec.forProvider.payload.baseUrl
        
        - type: CombineFromComposite
          combine:
            variables:
            - fromFieldPath: spec.make
            - fromFieldPath: spec.model
            - fromFieldPath: spec.color
            strategy: string
            string:
              fmt: |
                {
                  "make": "%s",
                  "model": "%s",
                  "color": "%s"
                }
          toFieldPath: spec.forProvider.payload.body
        
        - type: ToCompositeFieldPath
          fromFieldPath: status.response.body
          toFieldPath: status.car
          transforms:
          - type: convert
            convert:
              toType: object
              format: json
          policy:
            fromFieldPath: Optional